<!DOCYPE html>
<title>é†«ç™‚è«¾è©¢èŠå¤©å®¤</title>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¸æ“‡è¦è«®å•†çš„è™›æ“¬é†«äº‹äººå“¡</title>
  <link rel="stylesheet" href="static/style.css"/>
  <style>
    .chat-input-container {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
  
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
  
    .chat-input-container button {
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      color: white;
    }
  
    #sendBtn {
      background-color: #007bff;
    }
  
    #sendBtn:hover {
      background-color: #0056b3;
    }
  
    #micBtn {
      background-color: #28a745;
    }
  
    #micBtn:hover {
      background-color: #1e7e34;
    }

    .suggest-btn {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .suggest-btn:hover {
        background-color: #e0e0e0;
    }

    #downloadBtn {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.95rem;
        white-space: nowrap;
    }

    #downloadBtn {
        background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é–‹å•Ÿå´é‚Šæ¬„æŒ‰éˆ• -->
    <button id="toggleSidebarBtn" class="toggle-sidebar">é¸æ“‡é†«äº‹äººå“¡</button>
    
    <!-- è¿”å›é¸æ“‡å°ˆç§‘æŒ‰éˆ• -->
    <button id="backToSelectionBtn" style="
      position: fixed;
      top: 20px;
      right: 20px;
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      z-index: 1000;
    " onclick="window.location.href='/'">ğŸ”™ é‡æ–°é¸æ“‡æ•™æ¡ˆ</button>

    <aside class="sidebar hidden" id="sidebar">
      <h2>é¸æ“‡è¦è«®å•†çš„è™›æ“¬é†«äº‹äººå“¡</h2>
      <div class="character-list">
        <img src="static/images/pharmacist.jpg" alt="è—¥åŠ‘å¸«" class="thumbnail" onclick="selectCharacter(this.src, 'pharmacist')">
        <img src="static/images/psychiatrist.jpg" alt="ç²¾ç¥ç§‘é†«å¸«" class="thumbnail" onclick="selectCharacter(this.src, 'psychiatrist')">
        <img src="static/images/counselor.jpg" alt="å¿ƒç†è«®å•†å¸«" class="thumbnail" onclick="selectCharacter(this.src, 'counselor')">
        <img src="static/images/social_worker.jpg" alt="ç¤¾å·¥å¸«" class="thumbnail" onclick="selectCharacter(this.src, 'social_worker')">
      </div>
    </aside>

    <main class="main-content">
      <div class="selected-character">
        <h2>æ•™æ¡ˆåç¨±</h2>
        <img id="selectedImg" src="static/images/male_doctor.jpg" alt="é¸æ“‡çš„é†«ç”Ÿ">
        <!-- <b id="selectedName"></b> -->
        <div id="selectedSpecialty" style="margin-top: 10px; padding: 5px 10px; background: #e3f2fd; border-radius: 15px; font-size: 0.9rem; color: #1976d2;"></div>
      </div>

      <div class="chat-box">
        <h2>å°è©±ç´€éŒ„</h2>
        <div id="chatLog" class="chat-log">
          <div class="chat-message bot">æ‚¨å¥½ï¼æˆ‘å¯ä»¥ç‚ºæ‚¨æä¾›ä»€éº¼å”åŠ©ï¼Ÿ</div>
        </div>
      </div>

      <div class="controls">
        <div class="chat-input-container">
          <input type="text" id="chatInput" placeholder="è«‹è¼¸å…¥è¨Šæ¯..." />
          <button id="sendBtn">ğŸ“¤ ç™¼é€</button>
          <button id="micBtn">ğŸ¤</button>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="responseWithAudio" style="margin-right: 0.4rem;">
            Response with audio
          </label>
        
          <button id="downloadBtn">
            Download ChatLog
          </button>
        </div>
        <div id="suggestedQuestions" style="margin-top: 20px;">
          <h3>ğŸ’¡ ä½ å¯ä»¥å•æˆ‘ï¼š</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button class="suggest-btn">{{ random_question }}</button>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="loadingDialog" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    color: white;
    font-weight: bold;
  ">
    â³ Processing...
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    const questions = {{ questions | tojson }};
    const suggestBtn = document.getElementsByClassName("suggest-btn")[0];
  
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
    });
  
    function selectCharacter(src, role) {
      localStorage.setItem("selectedDoctor", src);
      localStorage.setItem("selectedRole", role);
      location.reload();
    }
  
    function appendChatMessage(role, text) {
      const msg = document.createElement("div");
      msg.className = `chat-message ${role}`;
      
      // Remove <think>...</think> tags and all content inside them
      const cleanedResult = text.replace(/<think>[\s\S]*?<\/think>/g, "");

      msg.innerText = cleanedResult;
      const chatLog = document.getElementById("chatLog");
      chatLog.appendChild(msg);
  
      // Cuá»™n xuá»‘ng sau khi thÃªm tin nháº¯n
      requestAnimationFrame(() => {
        document.getElementsByClassName("chat-box")[0].scrollTop = chatLog.scrollHeight;
      });
    }
  
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const checkbox = document.getElementById("responseWithAudio");
      const responseWithAudio = checkbox.checked; // true náº¿u Ä‘Æ°á»£c tick
      const modelType = localStorage.getItem('selectedSpecialty') || 'gdm'; // láº¥y giÃ¡ trá»‹ model type tá»« localStorage
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
        
      if (text) {
        document.getElementById("loadingDialog").style.display = "flex";
        appendChatMessage("user", text);
        input.value = "";
        const formData = new FormData();
        formData.append("question", text);
        const selectedRole = localStorage.getItem("selectedRole") || "unknown";
        formData.append("role", selectedRole);
        formData.append("model_type", modelType); // thÃªm model_type vÃ o form data
        console.log("Selected Role:", selectedRole, "Model Type:", modelType);
        formData.append("responseWithAudio", responseWithAudio);
        const response = await fetch("/ask", {
          method: "POST",
          body: formData
        });

        // appendChatMessage("bot", "è¬è¬æ‚¨ï¼Œæˆ‘æ­£åœ¨åˆ†æä¸­...");
        // Optional: gá»­i vá» server
        const result = await response.json();
        appendChatMessage("bot", result.answer);
        document.getElementById("loadingDialog").style.display = "none";
        // console.log(result)
        // playAmplitudes(result.audio); // â† phÃ¡t láº¡i Ã¢m thanh
        if ("audio_base64" in result){
            playRemoteMP3(result.audio_base64);
        }
      }
    });
  
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    const micBtn = document.getElementById("micBtn");
  
    micBtn.addEventListener("click", async () => {
      if (!isRecording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
  
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };
  
        mediaRecorder.onstop = async () => {
          document.getElementById("loadingDialog").style.display = "flex";
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const formData = new FormData();
          formData.append("audio", audioBlob, "recording.wav");
  
          // appendChatMessage("user", "ğŸ¤ï¼ˆéŸ³è¨Šå·²é€å‡ºï¼‰");
  
          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData
            });
  
            const result = await response.text();
  
            // Hiá»ƒn thá»‹ káº¿t quáº£ vÃ  cáº­p nháº­t input
            // appendChatMessage("bot", result);
            document.getElementById("chatInput").value = result;
            document.getElementById("loadingDialog").style.display = "none";
          } catch (err) {
            appendChatMessage("bot", "âŒ éŒ¯èª¤ï¼šç„¡æ³•è¾¨è­˜éŸ³è¨Š");
            document.getElementById("loadingDialog").style.display = "none";
          }
        };
  
        mediaRecorder.start();
        micBtn.innerText = "ğŸ›‘";
        isRecording = true;
      } else {
        mediaRecorder.stop();
        micBtn.innerText = "ğŸ¤";
        isRecording = false;
      }
    });

    function playAmplitudes(amplitudes, sampleRate = 22050) {
      const audioContext = new AudioContext({ sampleRate });
      // const gainFactor = 1; // Báº¡n cÃ³ thá»ƒ chá»‰nh sá»‘ nÃ y náº¿u váº«n quÃ¡ nhá»
    
      // Khuáº¿ch Ä‘áº¡i, nhÆ°ng Ä‘áº£m báº£o váº«n trong [-1, 1]
      // const normalized = amplitudes.map(v => {
      //   let val = v * gainFactor;
      //   return Math.max(-1, Math.min(1, val)); // clamp
      // });
    
      const buffer = audioContext.createBuffer(1, amplitudes.length, sampleRate);
      buffer.copyToChannel(new Float32Array(amplitudes), 0);
    
      const source = audioContext.createBufferSource();
      source.buffer = buffer;
      source.connect(audioContext.destination);
      source.start();
    }
    async function playRemoteMP3(audioBase64) {
      const baseURL = window.location.origin; // VÃ­ dá»¥: "https://myweb.com"
      const audioBlob = new Blob([new Uint8Array(atob(audioBase64).split('').map(char => char.charCodeAt(0)))], { type: 'audio/mp3' });
    
      const audioURL = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioURL);
      audio.play();
    }

    function changeQuestions(){
      let newQuestion;
      const current = suggestBtn.textContent.trim(); // loáº¡i bá» khoáº£ng tráº¯ng
    
      // Lá»c ra táº¥t cáº£ cÃ¢u há»i khÃ¡c vá»›i cÃ¢u hiá»‡n táº¡i
      const filtered = questions.filter(q => q.trim() !== current);
    
      if (filtered.length === 0) {
        console.warn("KhÃ´ng cÃ²n cÃ¢u há»i khÃ¡c Ä‘á»ƒ chá»n.");
        return;
      }
    
      newQuestion = filtered[Math.floor(Math.random() * filtered.length)];
      suggestBtn.textContent = newQuestion;
    }

      // Báº¯t sá»± kiá»‡n click cho cÃ¡c cÃ¢u há»i gá»£i Ã½
  document.querySelectorAll('.suggest-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // console.log(questions)
      const text = btn.textContent;
      document.getElementById("chatInput").value = text;
      document.getElementById("sendBtn").click();
      changeQuestions();
    });
  });
    document.addEventListener("DOMContentLoaded", () => {
      const savedDoctor = localStorage.getItem("selectedDoctor");
      const savedRoleName = localStorage.getItem("selectedRoleName");
      const savedSpecialty = localStorage.getItem("selectedSpecialty");
      
      if (savedDoctor) {
        document.getElementById('selectedImg').src = savedDoctor;
        // Name display removed
        // const nameConsultant = savedRoleName || "é†«å¸«";
        // document.getElementById('selectedName').textContent = nameConsultant;
      } else {
        // Náº¿u chÆ°a chá»n, chuyá»ƒn vá» trang chá»n chuyÃªn khoa
        window.location.href = '/';
      }
      
      // Hiá»ƒn thá»‹ thÃ´ng tin chuyÃªn khoa Ä‘Ã£ chá»n
      if (savedSpecialty) {
        let specialtyName = '';
        switch(savedSpecialty) {
          case 'gdm': specialtyName = 'å¦Šå¨ æœŸç³–å°¿ç—… (GDM)'; break;
          case 'ckd': specialtyName = 'æ…¢æ€§è…è‡Ÿç—… (CKD)'; break;
          case 'ppd': specialtyName = 'ç”¢å¾Œæ†‚é¬±ç—‡ (PPD)'; break;
        }
        document.title = `é†«ç™‚è«¾è©¢ - ${specialtyName}`;
      }
    });
    document.getElementById("downloadBtn").addEventListener("click", function () {
      const chatLog = document.getElementById("chatLog");
    
      const messages = Array.from(chatLog.getElementsByClassName("chat-message"))
        .map(msg => {
          const role = msg.classList.contains("bot") ? "Bot" : "User";
          const content = msg.innerText || msg.textContent;
          return `${role}: ${content}`;
        })
        .join("\n");
    
      const blob = new Blob([messages], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
    
      const a = document.createElement("a");
      a.href = url;
      a.download = "chatlog.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

  </script>
</body>
</html>
